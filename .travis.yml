sudo: required
env:
  # Run tests in parellel, up to 5 at once
  - DEVICE=ios91 TEST=commands FINAL_GULP=coveralls
  - DEVICE=ios91 TEST=e2e/testapp
  - DEVICE=ios91 TEST=e2e/uicatalog
  - DEVICE=ios91 TEST=e2e/safari/*.js
  - DEVICE=ios91 TEST=e2e/safari/webview/*.js
language:
  - objective-c
osx_image: xcode7.1
before_install:
  # TavisCI's OSX environment gives us node 0.10.32
  # Use NVM to update it to 0.12
  - rm -rf ~/.nvm
  - git clone https://github.com/creationix/nvm.git ~/.nvm
  - source ~/.nvm/nvm.sh
  - nvm install 0.12
  # Instruments fix:
  # https://github.com/travis-ci/travis-ci/issues/4218
  - ./bin/instruments-auth.sh
before_script:
  - npm install
  - npm install -g gulp
  - npm install -g mocha
  - gulp transpile
  # Xcode 7+ IWD
  # https://github.com/appium/appium/blob/master/docs/en/advanced-concepts/iwd_xcode7.md
  - xcode_path=/Applications/Xcode.app
  - appium_path=/Users/travis/build/appium/appium-ios-driver
  - plist_path=$xcode_path/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/Developer/Library/LaunchDaemons/com.apple.instruments.deviceservice.plist
  - iwd_path=$appium_path/node_modules/appium-instruments/thirdparty/iwd7
  - /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables dict" $plist_path
  - /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:DYLD_INSERT_LIBRARIES string $iwd_path/DTMobileISShim.dylib" $plist_path
  - /usr/libexec/PlistBuddy -c "Add :EnvironmentVariables:LIB_PATH string $iwd_path/" $plist_path
script:
  - mocha build/test/$TEST -g @skip-ci -i
  - if [ -n "$FINAL_GULP" ]; then gulp $FINAL_GULP; fi
